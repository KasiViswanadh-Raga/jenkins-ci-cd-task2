pipeline {
    agent any

    stages {
        stage('Pull Docker Image') {
            steps {
                sh 'docker pull node:18'
            }
        }

        stage('Run Container & Install') {
            steps {
                sh '''
                docker run --rm -v $(pwd):/app -w /app node:18 sh -c "npm install"
                '''
            }
        }

        stage('Run Tests') {
            steps {
                sh '''
                docker run --rm -v $(pwd):/app -w /app node:18 sh -c "npm test || echo No tests found"
                '''
            }
        }

        stage('Start App') {
            steps {
                sh '''
                docker run -d -v $(pwd):/app -w /app -p 8080:8080 node:18 sh -c "node index.js"
                '''
            }
        }
    }
}
